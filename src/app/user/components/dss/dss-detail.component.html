<div class="app-main__inner">

  <div class="app-page-title">
    <div class="page-title-wrapper">
      <div class="page-title-heading">
        <div class="page-title-icon">
          <i class="pe-7s-note icon-gradient bg-mean-fruit">
          </i>
        </div>
        <div>{{ 'DSS_details.Title' | translate }}</div>
      </div>
    </div>
  </div>

  <div class="container mx-auto my-5 page-box">
    <fieldset class="border p-3" *ngIf="dssIsValid; else showError">
      <legend class="w-auto px-1 text-muted h3">
        <b>{{ dssDetail.cropEppoCode | eppoCode }}</b>
      </legend>

      <div class="row form-group text-muted">
        <div class="col-md-4 col-xs-12">
          <label class="h6">
            <b>{{ dssDetail.pestEppoCode | eppoCode }}</b>
            <i [tooltip]="tolStatus" *ngIf="status>1"
              class="fas fa-circle pl-3 mr-5"
              [ngClass]="{'lowRisk': status==2, 'mediumRisk':status==3, 'highRisk': status==4}"></i>
            <i *ngIf="status<2"
              class="fas fa-circle pl-3 mr-5"
              [ngClass]="{'lowRisk': status==2, 'mediumRisk':status==3, 'highRisk': status==4}"></i>
          </label>
          <div class="row">
            <div class="col">
              <label for="start">{{ 'Common_labels.Start_Date' | translate }}:</label>
              <input type="date" id="startDate" name="period-start" [min]="minDate" [max]="startDateFormMax" (change)="startDateSelected($event)">
              &nbsp;<label for="end">{{ 'Common_labels.End_Date' | translate }}:</label>
              <input type="date" id="endDate" name="period-end" [min]="twoWeekAhead" [max]="maxDate" 
              (change)="endDateSelected($event)" [disabled]="!isStartDateSelected">
              <button class="btn btn-primary mt-3" (click)="onConfirmDays()" [disabled]="!isEndDateSelected">{{ 'Common_labels.Select' | translate }}</button>
            </div>
          </div>
        </div>
        <div class="col-md-4 col-xs-12">
          <label class="h6">
            <b>{{ dssDetail.dssModelName }}</b><a class="details" (click)="openModal(dssDetails,'modal-lg')">
              <i class="fas fa-info-circle light-blue-icon ml-1 icon-toggle"></i>
            </a>
          </label>
        </div>
        <div class="col-md-4 col-xs-12">
          <button class="btn btn-success" (click)="openModal(downloadModal,'modal-sm')">{{ 'DSS_details.Seasonal_data' | translate }}
            &nbsp;<i class="fas fa-file-download"></i>
          </button>
          <img src="{{dssDetail.dssLogoUrl}}">
        </div>
      </div>

      <div>
        <div class="row">
            <div class="col-md-4 col-xs-12">
              <b><label>{{ 'DSS_details.Risk_score' | translate }}</label></b>
              <custom-chart [data]="warning.data" [labels]="warning.labels" [config]="warning.chartInformation" [chartId]="'detailChart-'+dssDetail.id"
              [isAPopUpChart]="false">
              </custom-chart>
              <a (click)="openModal(expandedRiskChart, 'modal-xl')">
                <i class="fas fa-expand light-blue-icon risk-chart-popup-btn" [title]="('DSS_comparison.Expand_table' | translate)"></i>
              </a>
            </div>
            <div class="col-md-4 col-xs-12">
              <select class="form-control text-muted selItem" [ngModel]="selectedDssChartGroup"
                (ngModelChange)="onChangeChartGroup($event)" *ngIf="dssChartGroups.length > 1">
                <option *ngFor="let chartGroup of dssChartGroups" [ngValue]="chartGroup">{{ chartGroup.title }}
                </option>
              </select>
              <span *ngIf="dssChartGroups.length == 1" class="text-muted selItem">
                {{ dssChartGroups[0].title }}
              </span>
              <div class="row" *ngFor="let chartGroup of dssChartGroups">
                <div class="col-md-12 col-xs-12" *ngIf="selectedDssChartGroup.id === chartGroup.id">
                  <custom-group-chart [chartId]="'detailChart-'+chartGroup.id" [chartResultParameters]="chartGroup.resultParameters"
                  [isAPopUpChart]="false"></custom-group-chart>
                  <a (click)="openModal(expandedGroupChart, 'modal-xl')">
                    <i class="fas fa-expand light-blue-icon group-chart-popup-btn" [title]="('DSS_comparison.Expand_table' | translate)"></i>
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-4 col-xs-12">
              <b><label>{{ 'DSS_details.Recommended_actions' | translate }}</label></b>
              <div class=scrollableCell>
                <ul class="ml-3" *ngIf="dssDetail.warningStatusRepresentation !==''">
                  <li>
                    {{dssDetail.warningStatusRepresentation}}
                  </li>
                </ul>
              </div>
            </div>
        </div>
      <div class="row">
        
        <div class="col-md-4 offset-md-4 mt-3 mb-3">
          <accordion class="col-lg-12 col-xl-12" [isAnimated]="true" *ngIf="selectedDssChartGroup.id !=='' ">
            <accordion-group>
              <span accordion-heading tooltip="Click to show">
                {{ 'DSS_details.Show_data_legend' | translate }}
              </span>
              <div class="row" *ngFor="let result of selectedDssChartGroup.resultParameters">
                <i [ngStyle]="{ 'color': result.chartInformation?.color,'margin-right':'5px'}" class="fas fa-square"></i>
                <small class="d-flex justify-content-center"><b> {{result.title}} </b></small>
              </div>
            </accordion-group>
          </accordion>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col justify-content-center">
        <div class="d-flex justify-content-center m-3 alert alert-warning text-muted warningTextWrap">
          <strong>
            {{ 'DSS_details.Disclaimer_content' | translate }}
          </strong>
        </div>
      </div> 
    </div>
    </fieldset>
    <div class="form-group row pt-3">
      <div class="col-md-12">
        <button class="btn btn-info pull-right btn-w-100" type="button" (click)="goBack()">
          <i class="fas fa-arrow-left"></i> {{ 'Common_labels.Back' | translate }}
        </button>

        <button type="button" class="btn btn-md btn-primary btn-w-100" (click)="goToModelParameterisation()">
          <i class="fas fa-edit"></i>&nbsp;
          {{ 'DSS_details.Edit_parameters' | translate }}
        </button>

        <button type="button" class="btn btn-danger pull-right btn-w-100" (click)="openModal(deletedsstemplate)">
          <i class="fas fa-trash"></i> {{ 'Common_labels.Delete' | translate }}
        </button>
        <ng-template #deletedsstemplate>
          <div class="modal-header">
            <h4 class="modal-title pull-left">{{ 'DSS_details.Delete_DSS' | translate }}</h4>
            <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body"> 
            {{ 'Information_messages.DSS_delete' | translate }}
          </div>
          <div class="modal-footer pull-right">
            <button type="button" class="btn btn-default" (click)="modalRef.hide()">{{ 'Common_labels.Cancel' | translate }}</button>
            <button type="button" class="btn btn-primary" (click)="delete()">{{ 'Common_labels.Yes' | translate }}</button>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>

<ng-template #showError>
  <div class="form-group row mr-5">
    <div class="col-md-12 justify-content-center">
      <div class="alert alert-danger text-muted errorTextWrap">
        <strong>
          {{ 'Error_messages.DSS_an_error_occured' | translate }}:
        </strong>
        <br>
        {{ resultMessage }}
      </div>
    </div>
  </div>
  <!-- <div class="d-flex justify-content-center p-3 text-muted">
      <button type="button" 
        class="btn btn-md btn-primary" 
        (click)="goToModelParameterisation()">
          <i class="fas fa-plus"></i>&nbsp;
          Add Parameters
        </button>
    </div>-->
</ng-template>

<ng-template #tolStatus>
  <div [ngClass]="{'tolLowRisk': status==2, 'tolMediumRisk':status==3, 'tolHighRisk': status==4}">
    {{ status==2? ('DSS_use_dashboard.Low_risk' | translate) : null }}
    {{ status==3? ('DSS_use_dashboard.Medium_risk' | translate) : null }}
    {{ status==4? ('DSS_use_dashboard.High_risk' | translate) : null }}
  </div>
</ng-template>

<!-- DRAGGABLE AND RESIZABLE INFO MODAL-->
<ng-template #dssDetails>
  <resize-border [dragHolder]="header">
    <div class="d-flex flex-column">
      <div class="modal-header">
        <h4 #header class="modal-title w-100" id="modal-basic-title">
          <span class="modalInfoIcon fa-stack">
            <i class="fas fa-circle fa-stack-1x"></i>
            <i class="fas fa-info-circle fa-stack-1x"></i>
          </span> <b>{{ 'DSS_info_popup.Dss_informations' | translate }}</b> </h4>
        <button type="button" class="close" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body flex-grow-1">
            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.DSS_name' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.dssModelName }}</p>
              </div>
            </div>
            
            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.DSS_purpose' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.dssPurpose }}</p>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.DSS_model_id' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.dssModelId }}</p>
              </div>
            </div>
        
           <!-- <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.Warning_status_representation' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.warningStatusRepresentation }}</p>
              </div>
            </div>
        
            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.Warning_message' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.warningExplanation }}</p>
              </div>
            </div>-->
        
            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.Description' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.dssDescription }}</p>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><b>{{ 'DSS_info_popup.Authors_name' | translate }}</b></label>
              <div class="col-sm-9" *ngFor="let author of dssDetail.authors">
                  <p>{{ author.name }} ({{ author.organization }})</p>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.Source' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.dssName }}</p>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-3 col-form-label"><strong>{{ 'DSS_info_popup.Source_organisation' | translate }}</strong></label>
              <div class="col-sm-9">
                <p>{{ dssDetail.dssSource }}</p>
              </div>
            </div>
      </div>
    </div>
  </resize-border>
</ng-template>

<ng-template #expandedRiskChart>
  <div class="modal-header">
    <h4 class="modal-title pull-left">
      {{ 'DSS_details.Risk_score' | translate }}
    </h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
   <custom-chart [data]="warning.data" [labels]="warning.labels" [config]="warning.chartInformation" [chartId]="'detailChartPopup-'+dssDetail.id"
   [isAPopUpChart]="true">
  </custom-chart>
  </div>
  <div class="modal-footer">
    <div class="col-sm-7">
      <label for="start">{{ 'Common_labels.Start_Date' | translate }}:</label>
      <input type="date" id="startDatePopup" name="period-start" [min]="minDate" [max]="startDateFormMax" 
      [value]="startDate" (change)="startDateSelectedInPopup($event)">
      &nbsp;<label for="end">{{ 'Common_labels.End_Date' | translate }}:</label>
      <input type="date" id="endDatePopup" name="period-end" [min]="twoWeekAhead" [max]="maxDate" [value]="endDate" 
      (change)="endDateSelected($event)" [disabled]="!isStartDateSelected">
      <button class="btn btn-primary ml-2" (click)="onConfirmDays()" [disabled]="!isEndDateSelected">{{ 'Common_labels.Select' | translate }}</button>
    </div>
    <button type="button" class="btn btn-info push-right" (click)="closeModal()">{{ 'Common_labels.Close' | translate }}</button>
  </div>
</ng-template>

<ng-template #expandedGroupChart>
  <div class="modal-header">
    <h4 class="modal-title pull-left">
      <select class="form-control text-muted selItem" [ngModel]="selectedDssChartGroup"
        (ngModelChange)="onChangeChartGroup($event)" *ngIf="dssChartGroups.length > 1">
        <option *ngFor="let chartGroup of dssChartGroups" [ngValue]="chartGroup" style="font-weight: bold">
          {{ chartGroup.title }}
        </option>
      </select>
      <span *ngIf="dssChartGroups.length == 1" class="text-muted selItem">
        <b>{{ dssChartGroups[0].title }}</b>
      </span>
    </h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div>
      <div *ngFor="let chartGroup of dssChartGroups">
        <div *ngIf="selectedDssChartGroup.id === chartGroup.id">
          <custom-group-chart [chartId]="'detailChartPopup-'+chartGroup.id" [chartResultParameters]="chartGroup.resultParameters"
          [isAPopUpChart]="true"></custom-group-chart>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <div class="col-sm-7">
      <label for="start">{{ 'Common_labels.Start_Date' | translate }}:</label>
      <input type="date" id="startDatePopup" name="period-start" [min]="minDate" [max]="startDateFormMax" 
      [value]="startDate" (change)="startDateSelectedInPopup($event)">
      &nbsp;<label for="end">{{ 'Common_labels.End_Date' | translate }}:</label>
      <input type="date" id="endDatePopup" name="period-end" [min]="twoWeekAhead" [max]="maxDate" [value]="endDate" 
      (change)="endDateSelected($event)" [disabled]="!isStartDateSelected">
      <button class="btn btn-primary ml-2" (click)="onConfirmDays()" [disabled]="!isEndDateSelected">{{ 'Common_labels.Select' | translate }}</button>
    </div>
    <button type="button" class="btn btn-info push-right" (click)="closeModal()">{{ 'Common_labels.Close' | translate }}</button>
  </div>
</ng-template>

<ng-template #downloadModal>
  <div class="modal-header">
    <h4 class="modal-title pull-left">
      {{ 'DSS_details.Seasonal_data' | translate }}
    </h4>
    <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
      <label class="mr-2" for="name">{{ 'DSS_details.File_name' | translate }}:</label>
      <input type="text" id="file_name" required size="20">
      <div class="error_message" *ngIf="invalidFileName">
        {{ 'Error_messages.File_name_is_required' | translate }}
      </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-danger push-right" (click)="modalRef.hide()">{{ 'Common_labels.Close' | translate }}</button>
    <button type="button" class="btn btn-success push-left" 
    (click)="downloadSeasonalData()">{{ 'Common_labels.Download' | translate }}</button>
  </div>
</ng-template>